---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  fig.align = "center",
  fig.width = 9, 
  fig.height = 6
)
```

```{r srr-tags, eval = FALSE, echo = FALSE}
#' @srrstats {G1.1,  G1.2}
```

# dynamite: Bayesian Modeling and Causal Inference for Multivariate Longitudinal Data <img src="man/figures/logo.png" align="right" height="139"/></a>

The `dynamite` [R](https://www.r-project.org/) package provides an easy-to-use interface for Bayesian inference of complex panel (time series) data comprising of multiple measurements per multiple individuals measured in time via dynamic multivariate panel models (DMPM). The main features distinguishing the package and the underlying methodology from many other approaches are:

* Support for regular time-invariant effects, group-level random effects, and time-varying effects modeled via Bayesian P-splines.
* Joint modeling of multiple measurements per individual (multiple channels) based directly on the assumed data generating process. Individual channels can be univariate or multivariate.
* Support for various distributions: Currently Gaussian, Multivariate Gaussian, Student t, Categorical, Multinomial, Poisson, Bernoulli, Binomial, Negative Binomial, Gamma, Exponential, and Beta distributions are available, and these can be combined arbitrarily in multichannel models.
* Allows evaluating realistic long-term counterfactual predictions which take into account the dynamic structure of the model by posterior predictive distribution simulation.
* Transparent quantification of parameter and predictive uncertainty due to a fully Bayesian approach.
* User-friendly and efficient R interface with state-of-the-art estimation via Stan. Both `rstan` and `cmdstanr` backends are supported.

 For further information on DMPMs and the `dynamite` package, see the package vignettes.

## Installation

Please install the `dynamite` package using the provided tar.gz file. If on a Windows platform you may also need to update your `rstan` and `StanHeaders` installation by running
```{r, eval = FALSE, echo = TRUE}
remove.packages(c("rstan", "StanHeaders"))
install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
```

## Example

A single-channel model with time-invariant effect of `z`, time-varying effect of `x`, lagged value of the response variable `y` and a group-specific random intercepts:

```{r, echo = FALSE}
library(dynamite)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r, eval = FALSE}
set.seed(1)
library(dynamite)
gaussian_example_fit <- dynamite(
  obs(y ~ -1 + z + varying(~ x + lag(y)) + random(~1), family = "gaussian") +
    splines(df = 20),
  data = gaussian_example, time = "time", group = "id",
  iter = 2000, chains = 2, cores = 2, refresh = 0
)
```

```{r, echo = FALSE}
set.seed(1)
library(dynamite)
gaussian_example_fit <- update(gaussian_example_fit,
  iter = 2000, warmup = 1000, thin = 1,
  chains = 2, cores = 2, refresh = 0
)
```

Summary of the model:
```{r}
gaussian_example_fit
```

Posterior estimates of time-varying effects:
```{r, fig.width = 9, fig.height = 4}
plot_deltas(gaussian_example_fit, scales = "free")
```

And group-specific intercepts:
```{r, fig.width = 9, fig.height = 4}
plot_nus(gaussian_example_fit, groups = 1:10)
```

Traceplots and density plots:
```{r, fig.width = 9, fig.height = 4}
plot(gaussian_example_fit, type = "beta")
```

Posterior predictive samples for the first 4 groups (samples based on the posterior distribution of model parameters and observed data on first time point):

```{r, warning=FALSE, fig.width = 9, fig.height = 4}
library(ggplot2)
pred <- predict(gaussian_example_fit, n_draws = 100)
pred |>
  dplyr::filter(id < 5) |>
  ggplot(aes(time, y_new, group = .draw)) +
  geom_line(alpha = 0.25) +
  # observed values
  geom_line(aes(y = y), colour = "tomato") +
  facet_wrap(~id) +
  theme_bw()
```

## Related packages

- The `dynamite` package uses Stan via [`rstan`](https://CRAN.R-project.org/package=rstan) and [`cmdstanr`](https://mc-stan.org/cmdstanr/) (see also https://mc-stan.org), which is a probabilistic programming language for general Bayesian modelling.
- The [`brms`](https://CRAN.R-project.org/package=brms) package also uses Stan, and can be used to fit various complex multilevel models.
- Regression modeling with time-varying coefficients based on kernel smoothing and least squares estimation is available in package [`tvReg`](https://CRAN.R-project.org/package=tvReg). The [`tvem`](https://CRAN.R-project.org/package=tvem) package provides similar functionality for gaussian, binomial and poisson responses with [`mgcv`](https://CRAN.R-project.org/package=mgcv) backend.
- [`plm`](https://CRAN.R-project.org/package=plm) contains various methods to estimate linear models for panel data, e.g., fixed effect models.
- [`lavaan`](https://CRAN.R-project.org/package=lavaan) provides tools for structural equation modeling, and as such can be used to model various panel data models as well.
